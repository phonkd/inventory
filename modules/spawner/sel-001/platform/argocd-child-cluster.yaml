# ArgoCD Cluster Secret for phonkd-test-01 child cluster
# This uses the kubeconfig generated by CAPI Talos provider
#
# The secret phonkd-test-01-talosconfig contains the kubeconfig data
# We need to transform it into ArgoCD's expected format
#
# ArgoCD expects a secret with:
# - label: argocd.argoproj.io/secret-type: cluster
# - data.name: cluster name
# - data.server: kubernetes API server URL
# - data.config: JSON with connection config (including caData, certData, keyData or bearerToken)

---
# Option 1: Using a Job to create the ArgoCD cluster secret from the talosconfig
# This Job will run after the child cluster is provisioned and create the ArgoCD secret
apiVersion: v1
kind: ServiceAccount
metadata:
  name: argocd-cluster-register
  namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: argocd-cluster-register
  namespace: kube-system
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: argocd-cluster-register
  namespace: kube-system
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: argocd-cluster-register
subjects:
  - kind: ServiceAccount
    name: argocd-cluster-register
    namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: argocd-cluster-register
  namespace: argocd
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list", "watch", "create", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: argocd-cluster-register
  namespace: argocd
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: argocd-cluster-register
subjects:
  - kind: ServiceAccount
    name: argocd-cluster-register
    namespace: kube-system
---
apiVersion: batch/v1
kind: Job
metadata:
  name: argocd-register-phonkd-test-01
  namespace: kube-system
  annotations:
    # This annotation can be used by ArgoCD to control sync waves
    argocd.argoproj.io/sync-wave: "10"
spec:
  ttlSecondsAfterFinished: 3600
  backoffLimit: 30
  template:
    spec:
      serviceAccountName: argocd-cluster-register
      restartPolicy: OnFailure
      containers:
        - name: register-cluster
          image: rancher/kubectl:1.31
          command:
            - /bin/bash
            - -c
            - |
              set -e

              CLUSTER_NAME="phonkd-test-01"
              SOURCE_SECRET="${CLUSTER_NAME}-talosconfig"
              SOURCE_NS="kube-system"
              TARGET_NS="argocd"
              TARGET_SECRET="cluster-${CLUSTER_NAME}"

              echo "Waiting for secret ${SOURCE_SECRET} in namespace ${SOURCE_NS}..."

              # Wait for the talosconfig secret to exist (CAPI creates this after cluster provisioning)
              while ! kubectl get secret -n ${SOURCE_NS} ${SOURCE_SECRET} 2>/dev/null; do
                echo "Secret not found yet, waiting 30 seconds..."
                sleep 30
              done

              echo "Secret found! Extracting kubeconfig..."

              # The CAPI Talos provider stores kubeconfig in the 'kubeconfig' key
              # Extract and decode it
              KUBECONFIG_DATA=$(kubectl get secret -n ${SOURCE_NS} ${SOURCE_SECRET} -o jsonpath='{.data.kubeconfig}')

              if [ -z "$KUBECONFIG_DATA" ]; then
                echo "Error: kubeconfig key not found in secret"
                echo "Available keys:"
                kubectl get secret -n ${SOURCE_NS} ${SOURCE_SECRET} -o jsonpath='{.data}' | jq -r 'keys[]'
                exit 1
              fi

              # Decode kubeconfig to extract details
              echo "$KUBECONFIG_DATA" | base64 -d > /tmp/kubeconfig.yaml

              # Extract server URL, CA data, and client credentials from kubeconfig
              SERVER=$(cat /tmp/kubeconfig.yaml | grep -A5 'cluster:' | grep 'server:' | head -1 | awk '{print $2}')
              CA_DATA=$(cat /tmp/kubeconfig.yaml | grep 'certificate-authority-data:' | head -1 | awk '{print $2}')
              CLIENT_CERT=$(cat /tmp/kubeconfig.yaml | grep 'client-certificate-data:' | head -1 | awk '{print $2}')
              CLIENT_KEY=$(cat /tmp/kubeconfig.yaml | grep 'client-key-data:' | head -1 | awk '{print $2}')

              echo "Server: ${SERVER}"

              # Create ArgoCD cluster config JSON
              # ArgoCD expects tlsClientConfig with caData, certData, keyData
              CONFIG_JSON=$(cat <<EOF
              {
                "tlsClientConfig": {
                  "insecure": false,
                  "caData": "${CA_DATA}",
                  "certData": "${CLIENT_CERT}",
                  "keyData": "${CLIENT_KEY}"
                }
              }
              EOF
              )

              # Base64 encode the values for the secret
              NAME_B64=$(echo -n "${CLUSTER_NAME}" | base64 -w0)
              SERVER_B64=$(echo -n "${SERVER}" | base64 -w0)
              CONFIG_B64=$(echo -n "${CONFIG_JSON}" | base64 -w0)

              # Check if secret already exists
              if kubectl get secret -n ${TARGET_NS} ${TARGET_SECRET} 2>/dev/null; then
                echo "Secret ${TARGET_SECRET} already exists, updating..."
                kubectl patch secret -n ${TARGET_NS} ${TARGET_SECRET} --type='merge' -p "{
                  \"data\": {
                    \"name\": \"${NAME_B64}\",
                    \"server\": \"${SERVER_B64}\",
                    \"config\": \"${CONFIG_B64}\"
                  }
                }"
              else
                echo "Creating ArgoCD cluster secret ${TARGET_SECRET}..."
                cat <<EOF | kubectl apply -f -
              apiVersion: v1
              kind: Secret
              metadata:
                name: ${TARGET_SECRET}
                namespace: ${TARGET_NS}
                labels:
                  argocd.argoproj.io/secret-type: cluster
              type: Opaque
              data:
                name: ${NAME_B64}
                server: ${SERVER_B64}
                config: ${CONFIG_B64}
              EOF
              fi

              echo "Successfully registered cluster ${CLUSTER_NAME} with ArgoCD!"
              echo "You can now deploy applications to server: ${SERVER}"
