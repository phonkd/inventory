# Breakdown of how this works
# The mystrom exporter pod gets the metrics from the mystrom device.
# IMPORTANT: Leave the "--web.device-path=/device" as is.
# IMPORTANT: The "--target" argument is only available on the custom image build by arno4000 and is used to specify the IP address of the mystrom device
# IMPORTANT: DONT ADD A PATH TO THE SERVICEMONITORS ENDTPOINT, IT WILL BREAK
# The service creates an endpoint which the servicemonitor scrapes. To verify the endpoint selector on the servicemonitor is correct use "k get endpoints -l app=gagu"
apiVersion: v1
kind: Pod
metadata:
  name: mystrom-exporter
  namespace: monit
  labels:
    app: eis
spec:
  containers:
    - name: exporter-go-mystrom
      #image: ghcr.io/peschmae/exporter-go-mystrom:latest
      image: ghcr.io/kubierend/myschnibbler:main
      ports:
        - containerPort: 9452 # Exposed port
      command: ["/app/mystrom-exporter"]
      args:
        [
          "--web.listen-address=0.0.0.0:9452",
          "--web.device-path=/device",
          "--target=192.168.90.230",
        ]
---
apiVersion: v1
kind: Service
metadata:
  name: mystrom-exporter-service
  namespace: monit
  labels:
    app: gagu
spec:
  selector:
    app: eis
  ports:
    - protocol: TCP
      port: 9452 # Service port
      name: mystrom-exporter-svc-port
      targetPort: 9452 # Container port
  type: ClusterIP # Use NodePort or LoadBalancer for external access
---
# untestet chatgpt kaka
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: mystrom-servicemonitor
  namespace: monit
  labels:
    release: kube-prom-stack
spec:
  selector:
    matchLabels:
      app: gagu
  endpoints:
    - targetPort: 9452
      #      path: /
      interval: 3s
